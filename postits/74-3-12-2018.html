<!DOCTYPE html>
<html>
<head>

	<!-- style -->
	<link rel="stylesheet" href="../css/style.css">

	<!-- favicon -->
	<link rel="icon" href="../things/compass.png">

	<title>74</title>

</head>
<body>

	<a href="../index.html">..</a>

	<br></br>
	
	<h3>Analyze data with Turf.js and Mapbox GL JS - A Beginner's Tutorial</h3>

	This is the third in my mini-series of rewriting some of the Mapbox tutorials that might be overwhelming for people who haven't seen code before. Check out the <a href="https://mzdraper.github.io/postits/72-3-10-2018.html">first tutorial</a> to place markers on a map. <a href ="https://twitter.com/mzdraper">Let me know</a> what you think!

	<br></br>	

	We're going to use Mapbox GL JS and Turf.js to do some spatial analysis between points. <a href="turfjs.org">Turf.js</a> is a JavaScript library used for geospatial analysis. It has an array of GIS-esque tools and statistical tools. <a href="https://www.mapbox.com/help/analysis-with-turf/#finished-product">Here</a> is a link to Mapbox's actual tutorial and some examples of the map we'll be making today. 

	<br></br>

	What you'll need to get started:

	<ul>A <b>Mapbox account</b> that can be made freely with an email address. You will need this to generate an <b>access token</b>, which allows you to access Mapbox's API. Find more information <a href="https://www.mapbox.com/account/access-tokens/">here</a></ul>

	<ul>A <b>text editor</b>, which is a computer application where you write code. I use <a href="https://www.sublimetext.com/">Sublime</a>, but I know <a href="https://atom.io/">Atom</a> is also quite popular. Follow their download instructions carefully.</ul>

	<ul>A <b>new, empty folder</b> called <code>route</code> to store your HTML file.</ul>

	<ul><a href="https://github.com/mzdraper/mzdraper.github.io/blob/master/things/analyze-map.html">My super-commented route file</a>. This file contains all the code formatted correctly. I went through every line in the code and wrote extensive commentary explaining how it all works together. If you have knowledge of functions and variables, that would likely be more useful. But consider this document an 'in English' version of the code. The bits of this code (from Mapbox) and comments (from me) are in this tutorial to further explain what's going on while you do the tutorial. It's lengthy, but if you're new, it's a great place to start!</ul>

	<br>

	<h4>Step One: Initialize your Mapbox GL JS Map</h4>

	1. Open your text editor and save the file as <code>index.html</code>into your project folder.
	<br>
	2. Copy and paste the given code from Mapbox's tutorial.
	
	<xmp>
	<!DOCTYPE html>
	<html>
	<head>
	    <meta charset='utf-8' /> <!-- What character alphabet the computer can expect to read. -->
	    <title>Analyze</title><!-- This will appear as the name on the page tab. -->
	    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' /> <!-- Actually don't worry -->

	    <!-- These links load Mapbox GL JS to this document. -->
	    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
	    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />

	    <!-- This link loads Turf.js to this document. Turf.js is a JavaScript library for spatial analysis. There are spatial operations, GeoJSON data helper functions, and other statistical tools. -->
	    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>  

	    <!-- This is in-HTML line scripting of CSS, or cascade style sheets. These sheets can be written inside of HTML like this between <script> tags, or they can be linked outside of HTML documents using <script src='style.css'></script>. Everything between this <script> tag is CSS. --> 
	    <style>
	    	/* This styles everything in the body tags. */
			body {
				/* No spacing, only the map will cover the page */
				margin: 0;
				padding: 0;
			}

			/* This styles the map class. */
			#map {
				position: absolute; /* Positioned relative to its first positioned (not static) ancestor element. */
	            /* No spacing, so the map will take up the entire page. */
				top: 0;
				bottom: 0;
				width: 100%;
			}
	    </style>
	</head>

	<body>
		<!-- Creates a div (think like a physical bin) that can be referenced with the word "map" -->
		<div id='map'></div>

		<!-- Initiates JavaScript code. Everything between this <script> tag is JavaScript. -->
		<script>
		/* Replace with your Mapbox Access Token */
		mapboxgl.accessToken = 'pk.eyJ1IjoibWFkaXpoZW4iLCJhIjoiY2lzbTViZ2ozMDAyejJ5bzFxaXB0MXN2eCJ9.YVS0Rlj7IjNHireL_ysr6w';
		
		/* This creates a new Map called "map" */
		var map = new mapboxgl.Map({
			container: 'map', /* Container ID */
			style: 'mapbox://styles/mapbox/light-v9', /* This style can be replaced as you see fit. */
			center: [-84.5, 38.05], /* When the new lap is initiated, these are the [lat, long] coordinates that it will be at. */
			zoom: 11 /* When the new map is initiated, this is is the zoom level that it will be at. */
		});
			// code from the next step will go here!

		</script>
	</body>
	</html>
	</xmp>

	3. Save your file.
	4. Right click your file in Finder/Explorer and open it with your preferred browser. You should see a blank web map appear.

	<br>

	<h4>Step Two: Load the Data</h4>

	There are two sets of data used here: hospitals and libraries. They're both made into GeoJSON files. If you're familiar with JSON files, then GeoJSON are the same but with spatial bounds (coordinates). If you're unfamiliar with both, think of them as address books. You have an address book with contact cards that have a subset of personal information like phone number and birthday.

	<xmp>
    /* This creates an inline geoJSON. Think of it like an address book. The 'FeatureCollection' tells you there
	* are attributes. Then each {contact} tells you its type, it's address or 'geometry' and its properties or
	* letter contents. */
	var hospitals = {
	  type: 'FeatureCollection',
  	  features: [
        { type: 'Feature', properties: { Name: 'VA Medical Center -- Leestown Division', Address: '2250 Leestown Rd' }, geometry: { type: 'Point', coordinates: [-84.539487, 38.072916] } },
	    { type: 'Feature', properties: { Name: 'St. Joseph East', Address: '150 N Eagle Creek Dr' }, geometry: { type: 'Point', coordinates: [-84.440434, 37.998757] } },
	    { type: 'Feature', properties: { Name: 'Central Baptist Hospital', Address: '1740 Nicholasville Rd' }, geometry: { type: 'Point', coordinates: [-84.512283, 38.018918] } },
	    { type: 'Feature', properties: { Name: 'VA Medical Center -- Cooper Dr Division', Address: '1101 Veterans Dr' }, geometry: { type: 'Point', coordinates: [-84.506483, 38.02972] } },
	    { type: 'Feature', properties: { Name: 'Shriners Hospital for Children', Address: '1900 Richmond Rd' }, geometry: { type: 'Point', coordinates: [-84.472941, 38.022564] } },
	    { type: 'Feature', properties: { Name: 'Eastern State Hospital', Address: '627 W Fourth St' }, geometry: { type: 'Point', coordinates: [-84.498816, 38.060791] } },
	    { type: 'Feature', properties: { Name: 'Cardinal Hill Rehabilitation Hospital', Address: '2050 Versailles Rd' }, geometry: { type: 'Point', coordinates: [-84.54212, 38.046568] } },
	    { type: 'Feature', properties: { Name: 'St. Joseph Hospital', Address: '1 St Joseph Dr' }, geometry: { type: 'Point', coordinates: [-84.523636, 38.032475] } },
	    { type: 'Feature', properties: { Name: 'UK Healthcare Good Samaritan Hospital', Address: '310 S Limestone' }, geometry: { type: 'Point', coordinates: [-84.501222, 38.042123] } },
	    { type: 'Feature', properties: { Name: 'UK Medical Center', Address: '800 Rose St' }, geometry: { type: 'Point', coordinates: [-84.508205, 38.031254] } }
	  ]
	};
	var libraries = {
	  type: 'FeatureCollection',
	  	features: [
	    { type: 'Feature', properties: { Name: 'Village Branch', Address: '2185 Versailles Rd' }, geometry: { type: 'Point', coordinates: [-84.548369, 38.047876] } },
	    { type: 'Feature', properties: { Name: 'Northside Branch', Address: '1733 Russell Cave Rd' }, geometry: { type: 'Point', coordinates: [-84.47135, 38.079734] } },
	    { type: 'Feature', properties: { Name: 'Central Library', Address: '140 E Main St' }, geometry: { type: 'Point', coordinates: [-84.496894, 38.045459] } },
	    { type: 'Feature', properties: { Name: 'Beaumont Branch', Address: '3080 Fieldstone Way' }, geometry: { type: 'Point', coordinates: [-84.557948, 38.012502] } },
	    { type: 'Feature', properties: { Name: 'Tates Creek Branch', Address: '3628 Walden Dr' }, geometry: { type: 'Point', coordinates: [-84.498679, 37.979598] } },
	    { type: 'Feature', properties: { Name: 'Eagle Creek Branch', Address: '101 N Eagle Creek Dr' }, geometry: { type: 'Point', coordinates: [-84.442219, 37.999437] } }
	  ]
	};
	</xmp>

	Save your file, and refresh the page. You should see a map with libraries and hospitals!

	<h4>Step Three: Add Interactivity</h4>

	This is a beginning step to make the application usable to people. First add pop-ups to the markers so people know what institution they're looking at.

	<br></br>

	1. Place the following code directly after the code that added the pop-ups.

	<xmp>
    /* This creates pop-ups. */
	var popup = new mapboxgl.Popup();

	/* This can be read as: when the mouse moves on the map, run this function. e is the present placement of the map. */
	map.on('mousemove', function(e) {
		/* This is complex looking for sure, but here's what's happening. Start at e.point, this is finding what
		 * point your cursor is hovering. It's rendering your point and the layers' information to display if 
		 * the cursor is over any of the points. */
		var features = map.queryRenderedFeatures(e.point, { layers: ['hospitals', 'libraries'] });
		 /*If the length of the features is not (indicated by !) the e, then remove the pop-up. */ 
		if (!features.length) {
			popup.remove();
		return;
	}

	/* Programming starts counting at index 0, so this is assigning the first term in features to feature. */
	var feature = features[0];

	/* This set of method calls are all on the popup object. */
	popup.setLngLat(feature.geometry.coordinates) /* This gives the coordinates for the pop-up. */
		 .setHTML(feature.properties.Name) /* Converts Name into HTML and adds it to the pop-up. */
		 .addTo(map); /* Adds pop-up to the map. */

	map.getCanvas().style.cursor = features.length ? 'pointer' : '';

	});
	</xmp>

	Save your file and refresh the page to make sure your map still loads.

	<h4>Step Four: Add Turf.js</h4>

	We'll add Turf.js here to figure out which hospital is closet to the selected library.

	<xmp>
    map.addSource('nearest-hospital', {
	  type: 'geojson',
	  data: {
	    type: 'FeatureCollection',
	    features: [
	    ]
	  }
	});
    }    

    map.on('click', function(e) {
	  // Return any features from the 'libraries' layer whenever the map is clicked
	  var libraryFeatures = map.queryRenderedFeatures(e.point, { layers: ['libraries'] });
	  if (!libraryFeatures.length) {
	    return;
	  }
	  var libraryFeature = libraryFeatures[0];

	  // Using Turf, find the nearest hospital to library clicked
	  var nearestHospital = turf.nearest(libraryFeature, hospitals);

	  // If a nearest library is found
	  if (nearestHospital !== null) {
	    // Update the 'nearest-library' data source to include
	    // the nearest library
	    map.getSource('nearest-hospital').setData({
	      type: 'FeatureCollection',
	      features: [
	        nearestHospital
	      ]
	    }
	  );
	  // Create a new circle layer from the 'nearest-library' data source
	    map.addLayer({
	      id: 'nearest-hospital',
	      type: 'circle',
	      source: 'nearest-hospital',
	      paint: {
	        'circle-radius': 12,
	        'circle-color': '#486DE0'
	      }
	    }, 'hospitals');
	  }
	});
    </xmp>
    <i>The code directly above is the code from Mapbox's tutorial. To view my code, check <a href="https://github.com/mzdraper/mzdraper.github.io/blob/master/things/analyze-map.html">here</a>.</i>

    <br></br>

	Save your file, and refresh the page. You should see a map with markers for hospitals and libraries. Click on the library markers (indicated by open books), and you'll see the closest hospital highlighted by blue!

	<br></br>

	That's it! Good job on completing your web map! Please <a href="https://twitter.com/mzdraper">message me</a> screen shots of your map, or let me know about any questions or comments you have. Thanks for reading!

</body>
</html> 
